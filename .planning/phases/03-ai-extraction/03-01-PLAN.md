---
phase: 03-ai-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/gemini/client.ts
  - src/lib/schemas/extraction.ts
autonomous: true
user_setup:
  - service: google-gemini
    why: "AI-powered product data extraction"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio (https://aistudio.google.com/apikey)"

must_haves:
  truths:
    - "Gemini SDK is installed and importable"
    - "Extraction schema defines all required product fields"
    - "Schema can be converted to JSON Schema for Gemini"
  artifacts:
    - path: "src/lib/gemini/client.ts"
      provides: "GoogleGenAI client initialization"
      exports: ["ai", "EXTRACTION_MODEL"]
    - path: "src/lib/schemas/extraction.ts"
      provides: "Zod schema for extraction output"
      exports: ["extractedProductSchema", "ExtractedProduct", "extractedProductJsonSchema"]
  key_links:
    - from: "src/lib/schemas/extraction.ts"
      to: "zod"
      via: "z.toJSONSchema()"
      pattern: "z\\.toJSONSchema"
---

<objective>
Set up Gemini SDK and create extraction schema for AI-powered product data extraction.

Purpose: Establish the foundation for Gemini API integration with typed extraction schema that guarantees structured output.
Output: Gemini client module and Zod schema that converts to JSON Schema for structured extraction.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ai-extraction/03-RESEARCH.md
@package.json
@src/lib/schemas/product.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @google/genai SDK</name>
  <files>package.json</files>
  <action>
Run `npm install @google/genai` to add the official Google Gemini SDK.

This is the unified SDK for Gemini API (not the deprecated @google/generative-ai).
Version should be ^1.37.0 or later.
  </action>
  <verify>
Run `npm ls @google/genai` - should show installed version.
Check package.json contains "@google/genai" in dependencies.
  </verify>
  <done>@google/genai is installed and listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Gemini client module</name>
  <files>src/lib/gemini/client.ts</files>
  <action>
Create `src/lib/gemini/client.ts` with:

1. Import GoogleGenAI from @google/genai
2. Check for GEMINI_API_KEY environment variable - throw clear error if missing
3. Export initialized `ai` client instance
4. Export `EXTRACTION_MODEL` constant set to "gemini-3-flash-preview" (per PROJECT.md)

Pattern from research:
```typescript
import { GoogleGenAI } from "@google/genai";

if (!process.env.GEMINI_API_KEY) {
  throw new Error("GEMINI_API_KEY environment variable is required");
}

export const ai = new GoogleGenAI({
  apiKey: process.env.GEMINI_API_KEY,
});

export const EXTRACTION_MODEL = "gemini-3-flash-preview";
```

IMPORTANT: This file is server-only. Never import in client components.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
File exists at src/lib/gemini/client.ts
  </verify>
  <done>Gemini client exports ai instance and EXTRACTION_MODEL constant</done>
</task>

<task type="auto">
  <name>Task 3: Create extraction schema</name>
  <files>src/lib/schemas/extraction.ts</files>
  <action>
Create `src/lib/schemas/extraction.ts` with Zod schema for extraction output:

1. Define `extractedProductSchema` with these fields (all with .describe() for LLM context):
   - name: z.string() - Product name as stated by vendor
   - sku: z.string() - Vendor SKU, catalog number, or part number
   - description: z.string().nullable() - Full product description
   - price: z.number().nullable() - Unit price (numeric only, no currency)
   - vendor_name: z.string().nullable() - Vendor or manufacturer name
   - material_name: z.string().nullable() - Primary material (titanium, PEEK, etc.)
   - ce_marked: z.boolean() - True if CE marking mentioned
   - mdr_class: z.enum(["I", "IIa", "IIb", "III"]).nullable() - MDR classification if stated
   - udi_di: z.string().nullable() - UDI-DI if provided (max 14 chars)
   - suggested_emdn: z.string().nullable() - Suggested EMDN code (P09xx or P10xx)

2. Export type `ExtractedProduct` from schema inference

3. Export `extractedProductJsonSchema` using Zod v4 native conversion:
   ```typescript
   export const extractedProductJsonSchema = z.toJSONSchema(extractedProductSchema, {
     target: "draft-2020-12",
   });
   ```

Key difference from productSchema: This schema has vendor_name and material_name as strings (extracted text), not UUIDs. The preview form will resolve these to IDs later.

Do NOT use transforms, Date, bigint, or undefined - these are unrepresentable in JSON Schema.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Import and log JSON Schema in a test: should output valid JSON Schema object
  </verify>
  <done>extractedProductSchema, ExtractedProduct type, and extractedProductJsonSchema are exported</done>
</task>

</tasks>

<verification>
1. `npm ls @google/genai` shows installed package
2. `npx tsc --noEmit` passes with no errors
3. Files exist:
   - src/lib/gemini/client.ts
   - src/lib/schemas/extraction.ts
</verification>

<success_criteria>
- Gemini SDK installed and importable
- Client module exports ai instance with API key validation
- Extraction schema exports Zod schema, TypeScript type, and JSON Schema
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-extraction/03-01-SUMMARY.md`
</output>
