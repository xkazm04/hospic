---
phase: 03-ai-extraction
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/extraction/upload-form.tsx
  - src/components/extraction/extraction-preview.tsx
autonomous: true

must_haves:
  truths:
    - "User can select and upload .txt/.md file"
    - "Upload form shows loading state during extraction"
    - "Extracted data displays in editable form"
    - "User can modify any extracted field"
    - "Preview form has dropdowns for vendor, material, EMDN selection"
  artifacts:
    - path: "src/components/extraction/upload-form.tsx"
      provides: "File upload form with drag-drop zone"
      exports: ["UploadForm"]
    - path: "src/components/extraction/extraction-preview.tsx"
      provides: "Editable preview form for extracted data"
      exports: ["ExtractionPreview"]
  key_links:
    - from: "src/components/extraction/upload-form.tsx"
      to: "src/lib/actions/extraction.ts"
      via: "calls extractFromProductSheet"
      pattern: "extractFromProductSheet"
    - from: "src/components/extraction/extraction-preview.tsx"
      to: "src/lib/actions/products.ts"
      via: "calls createProduct"
      pattern: "createProduct"
---

<objective>
Create upload form and extraction preview components for the AI extraction workflow.

Purpose: Enable users to upload vendor product sheets and review/edit extracted data before saving.
Output: UploadForm component for file selection and ExtractionPreview for editing extracted data.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-ai-extraction/03-RESEARCH.md
@src/lib/actions/extraction.ts
@src/lib/actions/products.ts
@src/lib/schemas/extraction.ts
@src/components/product/product-form.tsx
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload form component</name>
  <files>src/components/extraction/upload-form.tsx</files>
  <action>
Create `src/components/extraction/upload-form.tsx`:

1. Mark as "use client"
2. Import useState, useTransition from react
3. Import Upload, FileText, Loader2 from lucide-react
4. Import extractFromProductSheet from actions/extraction
5. Import ExtractedProduct type from schemas/extraction

6. Define props interface:
   ```typescript
   interface UploadFormProps {
     onExtracted: (data: ExtractedProduct) => void;
   }
   ```

7. Implement UploadForm component:
   - useState for error (string | null)
   - useState for fileName (string | null)
   - useTransition for isPending

8. handleFileChange: Update fileName, clear error

9. handleSubmit as form action:
   ```typescript
   function handleSubmit(formData: FormData) {
     setError(null);
     startTransition(async () => {
       const result = await extractFromProductSheet(formData);
       if (result.success && result.data) {
         onExtracted(result.data);
       } else {
         setError(result.error ?? "Extraction failed");
       }
     });
   }
   ```

10. JSX structure:
    - form with action={handleSubmit}
    - Dashed border drop zone (styled with Tailwind)
    - Hidden file input (accept=".txt,.md", name="file")
    - Label that shows Upload icon and fileName or prompt text
    - Error message display (text-red-500)
    - Submit button with loading state (disabled when isPending or no file)

Style classes to use (matching existing patterns):
- Drop zone: `border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-accent transition-colors`
- Button: `w-full bg-accent text-accent-foreground py-2 px-4 rounded-md font-medium disabled:opacity-50`
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component exports UploadForm
  </verify>
  <done>UploadForm accepts file, shows loading, calls extraction action, reports result via callback</done>
</task>

<task type="auto">
  <name>Task 2: Create extraction preview component</name>
  <files>src/components/extraction/extraction-preview.tsx</files>
  <action>
Create `src/components/extraction/extraction-preview.tsx`:

1. Mark as "use client"
2. Import useState, useTransition from react
3. Import useForm from react-hook-form
4. Import zodResolver from @hookform/resolvers/zod
5. Import productSchema from schemas/product
6. Import createProduct from actions/products
7. Import ExtractedProduct type from schemas/extraction

8. Define props interface:
   ```typescript
   interface ExtractionPreviewProps {
     extractedData: ExtractedProduct;
     vendors: { id: string; name: string }[];
     materials: { id: string; name: string }[];
     emdnCategories: { id: string; code: string; name: string }[];
     onSuccess: () => void;
     onCancel: () => void;
   }
   ```

9. Implement ExtractionPreview component:
   - Find matching vendor by name (case-insensitive partial match)
   - Find matching material by name
   - Find matching EMDN by suggested code

   ```typescript
   const matchedVendor = vendors.find(v =>
     extractedData.vendor_name &&
     v.name.toLowerCase().includes(extractedData.vendor_name.toLowerCase())
   );
   const matchedMaterial = materials.find(m =>
     extractedData.material_name &&
     m.name.toLowerCase().includes(extractedData.material_name.toLowerCase())
   );
   const matchedEmdn = emdnCategories.find(c =>
     extractedData.suggested_emdn &&
     c.code === extractedData.suggested_emdn
   );
   ```

10. Initialize React Hook Form with productSchema:
    - Use zodResolver(productSchema)
    - defaultValues map extracted data to form fields:
      - name, sku, description, price, ce_marked, mdr_class, udi_di from extractedData
      - vendor_id: matchedVendor?.id ?? undefined
      - material_id: matchedMaterial?.id ?? undefined
      - emdn_category_id: matchedEmdn?.id ?? undefined

11. onSubmit handler:
    - Build FormData from validated data
    - Call createProduct(formData)
    - On success: call onSuccess()
    - On error: setServerError

12. JSX structure (reuse styling from ProductForm):
    - Show extracted vendor_name, material_name, suggested_emdn as info labels above dropdowns
    - All fields from ProductForm: name, sku, description, price, vendor dropdown, material dropdown, EMDN dropdown, udi_di, ce_marked checkbox, mdr_class dropdown
    - Two buttons: "Cancel" (calls onCancel) and "Save to Catalog" (submit)

Key UX: Show the raw extracted text (e.g., "Extracted vendor: Synthes") above the dropdown so user knows what was matched.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component exports ExtractionPreview
  </verify>
  <done>ExtractionPreview displays extracted data, allows editing, resolves names to IDs, saves via createProduct</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. src/components/extraction/upload-form.tsx exports UploadForm
3. src/components/extraction/extraction-preview.tsx exports ExtractionPreview
</verification>

<success_criteria>
- UploadForm handles file selection, shows loading, calls extraction action
- ExtractionPreview pre-fills form with extracted data
- Name-to-ID matching works for vendor, material, EMDN
- User can edit all fields before saving
- Save uses createProduct action with proper validation
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-extraction/03-03-SUMMARY.md`
</output>
