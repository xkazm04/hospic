---
phase: 03-ai-extraction
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/components/extraction/extraction-sheet.tsx
  - src/components/catalog-client.tsx
autonomous: false

must_haves:
  truths:
    - "Extraction sheet opens from catalog page"
    - "User can upload file and see extracted preview"
    - "After save, sheet closes and catalog refreshes"
    - "Full workflow: upload -> extract -> preview/edit -> save works end-to-end"
  artifacts:
    - path: "src/components/extraction/extraction-sheet.tsx"
      provides: "Sheet component orchestrating extraction workflow"
      exports: ["ExtractionSheet"]
    - path: "src/components/catalog-client.tsx"
      provides: "Updated client with extraction sheet integration"
      contains: "ExtractionSheet"
  key_links:
    - from: "src/components/extraction/extraction-sheet.tsx"
      to: "src/components/extraction/upload-form.tsx"
      via: "renders UploadForm"
      pattern: "<UploadForm"
    - from: "src/components/extraction/extraction-sheet.tsx"
      to: "src/components/extraction/extraction-preview.tsx"
      via: "renders ExtractionPreview"
      pattern: "<ExtractionPreview"
    - from: "src/components/catalog-client.tsx"
      to: "src/components/extraction/extraction-sheet.tsx"
      via: "renders ExtractionSheet"
      pattern: "<ExtractionSheet"
---

<objective>
Create extraction sheet and integrate into catalog page for complete extraction workflow.

Purpose: Provide UI container for extraction workflow and wire everything together for end-to-end functionality.
Output: ExtractionSheet component and updated CatalogClient with "Add Product" button.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-ai-extraction/03-RESEARCH.md
@src/components/extraction/upload-form.tsx
@src/components/extraction/extraction-preview.tsx
@src/components/ui/sheet.tsx
@src/components/catalog-client.tsx
@src/components/product/product-sheet.tsx
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction sheet component</name>
  <files>src/components/extraction/extraction-sheet.tsx</files>
  <action>
Create `src/components/extraction/extraction-sheet.tsx`:

1. Mark as "use client"
2. Import useState from react
3. Import Sheet, SheetContent, SheetHeader, SheetTitle from ui/sheet
4. Import UploadForm from ./upload-form
5. Import ExtractionPreview from ./extraction-preview
6. Import ExtractedProduct from schemas/extraction
7. Import Vendor, Material, EMDNCategory from lib/types

8. Define props interface:
   ```typescript
   interface ExtractionSheetProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     vendors: Vendor[];
     materials: Material[];
     emdnCategories: EMDNCategory[];
   }
   ```

9. Implement ExtractionSheet component:
   - useState for step: 'upload' | 'preview'
   - useState for extractedData: ExtractedProduct | null

10. Reset state when sheet opens:
    ```typescript
    useEffect(() => {
      if (open) {
        setStep('upload');
        setExtractedData(null);
      }
    }, [open]);
    ```

11. Handlers:
    - handleExtracted(data): setExtractedData(data), setStep('preview')
    - handleSuccess(): onOpenChange(false) (close sheet, data revalidates automatically)
    - handleCancel(): setStep('upload'), setExtractedData(null)

12. JSX structure:
    ```jsx
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent side="right">
        <SheetHeader>
          <SheetTitle>
            {step === 'upload' ? 'Extract Product from File' : 'Review Extracted Data'}
          </SheetTitle>
        </SheetHeader>

        <div className="px-6 py-4">
          {step === 'upload' ? (
            <UploadForm onExtracted={handleExtracted} />
          ) : extractedData ? (
            <ExtractionPreview
              extractedData={extractedData}
              vendors={vendors.map(v => ({ id: v.id, name: v.name }))}
              materials={materials.map(m => ({ id: m.id, name: m.name }))}
              emdnCategories={emdnCategories.map(c => ({ id: c.id, code: c.code, name: c.name }))}
              onSuccess={handleSuccess}
              onCancel={handleCancel}
            />
          ) : null}
        </div>
      </SheetContent>
    </Sheet>
    ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component exports ExtractionSheet
  </verify>
  <done>ExtractionSheet manages upload->preview flow and renders appropriate component based on step</done>
</task>

<task type="auto">
  <name>Task 2: Integrate extraction sheet into catalog</name>
  <files>src/components/catalog-client.tsx</files>
  <action>
Update `src/components/catalog-client.tsx` to add extraction functionality:

1. Add import for ExtractionSheet from extraction/extraction-sheet
2. Add import for Plus icon from lucide-react

3. Add state for extraction sheet:
   ```typescript
   const [extractionSheetOpen, setExtractionSheetOpen] = useState(false);
   ```

4. Add "Add Product" button above the table:
   ```jsx
   <div className="mb-4 flex justify-end">
     <button
       onClick={() => setExtractionSheetOpen(true)}
       className="flex items-center gap-2 bg-accent text-accent-foreground py-2 px-4 rounded-md font-medium hover:bg-accent/90 transition-colors"
     >
       <Plus className="h-4 w-4" />
       Add Product
     </button>
   </div>
   ```

5. Add ExtractionSheet component (after ProductSheet):
   ```jsx
   <ExtractionSheet
     open={extractionSheetOpen}
     onOpenChange={setExtractionSheetOpen}
     vendors={vendors}
     materials={materials}
     emdnCategories={emdnCategories}
   />
   ```

The button placement: Above the DataTable, aligned right. This matches common catalog UI patterns.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
"Add Product" button visible in catalog
  </verify>
  <done>CatalogClient has "Add Product" button that opens ExtractionSheet</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI extraction workflow: file upload -> Gemini extraction -> preview/edit -> save to catalog</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000
3. Click "Add Product" button (top right of catalog)
4. Upload a test .txt or .md file containing product info (create simple test file if needed):
   ```
   Product: Titanium Hip Stem
   SKU: THS-2024
   Vendor: Synthes
   Price: 45000 CZK
   Material: Titanium alloy
   CE Marked: Yes
   MDR Class: III
   ```
5. Wait for extraction (should show loading state)
6. Verify extracted data appears in preview form
7. Check that vendor/material/EMDN dropdowns have pre-selected matches (if available)
8. Edit any field if desired
9. Click "Save to Catalog"
10. Verify sheet closes and new product appears in table

Expected: Full workflow completes, product saved to database, visible in catalog.
  </how-to-verify>
  <resume-signal>Type "approved" if workflow works end-to-end, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run dev` starts without errors
3. "Add Product" button visible in catalog
4. Full extraction workflow functional
</verification>

<success_criteria>
- ExtractionSheet orchestrates upload -> preview -> save flow
- "Add Product" button in catalog opens extraction sheet
- User can upload file, see extraction, edit, and save
- New products appear in catalog after save
- All requirements EXTR-01 through EXTR-05 met
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-extraction/03-04-SUMMARY.md`
</output>
