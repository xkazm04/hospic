---
phase: 04-comparison-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/003_similarity_search.sql
  - src/lib/actions/similarity.ts
autonomous: true

must_haves:
  truths:
    - "pg_trgm extension is enabled in database"
    - "find_similar_products RPC function accepts name/sku and returns similar products"
    - "get_product_price_comparison RPC function accepts product ID and returns grouped prices"
    - "Server Actions can be called from client components"
  artifacts:
    - path: "supabase/migrations/003_similarity_search.sql"
      provides: "pg_trgm extension, indexes, RPC functions"
      contains: "CREATE EXTENSION IF NOT EXISTS pg_trgm"
    - path: "src/lib/actions/similarity.ts"
      provides: "Server Actions for similarity search"
      exports: ["findSimilarProducts", "getProductPriceComparison", "SimilarProduct", "ProductPriceComparison"]
  key_links:
    - from: "src/lib/actions/similarity.ts"
      to: "supabase rpc"
      via: "supabase.rpc() calls"
      pattern: "supabase\\.rpc\\("
---

<objective>
Set up the database foundation for similarity detection and create Server Actions for querying similar products.

Purpose: This plan enables the core functionality for Phase 4 - detecting similar products using PostgreSQL's pg_trgm trigram matching and exposing this via Server Actions that can be called from UI components.

Output: Migration file with pg_trgm extension and RPC functions, plus TypeScript Server Actions for findSimilarProducts and getProductPriceComparison.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-comparison-engine/04-RESEARCH.md
@src/lib/supabase/server.ts
@src/lib/actions/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pg_trgm migration with RPC functions</name>
  <files>supabase/migrations/003_similarity_search.sql</files>
  <action>
Create migration file that:
1. Enables pg_trgm extension: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`
2. Creates GIN indexes for fast trigram search on products.name and products.sku
3. Creates `find_similar_products(search_name TEXT, search_sku TEXT, similarity_threshold REAL, max_results INT)` RPC function that:
   - Returns TABLE (id UUID, name TEXT, sku TEXT, price DECIMAL(10,2), vendor_id UUID, vendor_name TEXT, name_similarity REAL, sku_similarity REAL)
   - Uses LOWER() for case-insensitive matching
   - Matches on name similarity > threshold OR sku similarity > 0.8
   - Orders by GREATEST similarity DESC, limits results
   - Uses SECURITY DEFINER and LANGUAGE plpgsql
4. Creates `get_product_price_comparison(product_id UUID, similarity_threshold REAL)` RPC function that:
   - Returns TABLE (id UUID, name TEXT, sku TEXT, price DECIMAL(10,2), vendor_id UUID, vendor_name TEXT, similarity REAL)
   - Gets target product name, finds all similar products
   - Orders by price ASC NULLS LAST for easy price comparison
   - Uses SECURITY DEFINER and LANGUAGE plpgsql
5. GRANTs EXECUTE to anon and authenticated roles

Use the patterns from 04-RESEARCH.md exactly - they handle case sensitivity and NULL values correctly.
  </action>
  <verify>
- File exists at supabase/migrations/003_similarity_search.sql
- Contains CREATE EXTENSION pg_trgm
- Contains CREATE INDEX idx_products_name_trgm and idx_products_sku_trgm
- Contains both RPC functions with correct signatures
- Contains GRANT EXECUTE statements
  </verify>
  <done>
Migration file ready for manual execution in Supabase SQL Editor. Contains pg_trgm extension, GIN indexes, and both RPC functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create similarity Server Actions</name>
  <files>src/lib/actions/similarity.ts</files>
  <action>
Create new Server Action file with "use server" directive that exports:

1. `SimilarProduct` interface:
   - id: string, name: string, sku: string, price: number | null
   - vendor_id: string | null, vendor_name: string | null
   - name_similarity: number, sku_similarity: number

2. `ProductPriceComparison` interface:
   - id: string, name: string, sku: string, price: number | null
   - vendor_id: string | null, vendor_name: string | null
   - similarity: number

3. `findSimilarProducts(name: string, sku?: string, threshold?: number)` async function:
   - Default threshold 0.3
   - Calls supabase.rpc("find_similar_products", {...})
   - Returns { success: boolean; data?: SimilarProduct[]; error?: string }
   - Handles errors gracefully with console.error

4. `getProductPriceComparison(productId: string, threshold?: number)` async function:
   - Default threshold 0.5 (higher for price grouping)
   - Calls supabase.rpc("get_product_price_comparison", {...})
   - Returns { success: boolean; data?: ProductPriceComparison[]; error?: string }
   - Handles errors gracefully

Follow the pattern from existing src/lib/actions/products.ts for error handling and Supabase client usage.
  </action>
  <verify>
- File exists at src/lib/actions/similarity.ts
- Has "use server" directive at top
- Exports SimilarProduct and ProductPriceComparison types
- Exports findSimilarProducts and getProductPriceComparison functions
- TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
Server Actions ready to be called from client components. Both functions return typed results with success/error handling.
  </done>
</task>

</tasks>

<verification>
1. Migration file syntax is valid SQL
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Server Actions import successfully in a test file
</verification>

<success_criteria>
- Migration file contains all required SQL (extension, indexes, 2 RPC functions, grants)
- Server Actions file exports 2 typed interfaces and 2 async functions
- No TypeScript compilation errors
- Code follows existing project patterns (error handling, Supabase client usage)
</success_criteria>

<output>
After completion, create `.planning/phases/04-comparison-engine/04-01-SUMMARY.md`
</output>
