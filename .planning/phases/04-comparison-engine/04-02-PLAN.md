---
phase: 04-comparison-engine
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/extraction/similar-products-warning.tsx
  - src/components/extraction/extraction-preview.tsx
autonomous: true

must_haves:
  truths:
    - "User sees warning when extracted product is similar to existing products"
    - "Warning shows similarity percentage for each match"
    - "Warning shows vendor name for each similar product"
    - "User can proceed with saving despite warning (warn, don't block)"
  artifacts:
    - path: "src/components/extraction/similar-products-warning.tsx"
      provides: "Warning UI component for similar products"
      exports: ["SimilarProductsWarning"]
      min_lines: 30
    - path: "src/components/extraction/extraction-preview.tsx"
      provides: "Extraction preview with similarity check integration"
      contains: "SimilarProductsWarning"
  key_links:
    - from: "src/components/extraction/extraction-preview.tsx"
      to: "src/lib/actions/similarity.ts"
      via: "findSimilarProducts import and call"
      pattern: "findSimilarProducts"
    - from: "src/components/extraction/extraction-preview.tsx"
      to: "src/components/extraction/similar-products-warning.tsx"
      via: "component import and render"
      pattern: "SimilarProductsWarning"
---

<objective>
Add similar products warning to the extraction preview workflow.

Purpose: When users extract product data from vendor sheets, they should see a warning if similar products already exist in the catalog. This implements DUPL-01 and DUPL-02 requirements - warning users without blocking them from adding products (same product from different vendors is valid).

Output: SimilarProductsWarning component and updated ExtractionPreview that checks for similar products after extraction.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comparison-engine/04-RESEARCH.md
@.planning/phases/04-comparison-engine/04-01-SUMMARY.md
@src/components/extraction/extraction-preview.tsx
@src/lib/actions/similarity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SimilarProductsWarning component</name>
  <files>src/components/extraction/similar-products-warning.tsx</files>
  <action>
Create a new client component that displays a warning panel when similar products are found:

1. Mark as "use client"

2. Import:
   - AlertTriangle icon from lucide-react
   - SimilarProduct type from @/lib/actions/similarity

3. Props interface SimilarProductsWarningProps:
   - products: SimilarProduct[]
   - isLoading: boolean (shows loading state while checking)

4. Component implementation:
   - If isLoading, show subtle "Checking for similar products..." text with spinner
   - If products.length === 0, return null (no warning needed)
   - Render amber/yellow warning box (bg-amber-50, border-amber-200)
   - AlertTriangle icon in amber color
   - Heading: "Similar products found"
   - Subtext: "This product may already exist in the catalog. Review before saving."
   - List of similar products showing:
     - Product name
     - Vendor name in parentheses if available
     - Similarity percentage (Math.round(name_similarity * 100))
   - Use Tailwind classes consistent with existing components

5. Styling should match project conventions:
   - Use border-border, text-foreground patterns from existing code
   - Amber warning colors: bg-amber-50, border-amber-200, text-amber-600/700/800
  </action>
  <verify>
- File exists at src/components/extraction/similar-products-warning.tsx
- Exports SimilarProductsWarning component
- Handles loading state
- Handles empty products array (returns null)
- Shows warning panel with product list when products exist
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
SimilarProductsWarning component renders warning panel with similar product list and similarity percentages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate similarity check into ExtractionPreview</name>
  <files>src/components/extraction/extraction-preview.tsx</files>
  <action>
Modify ExtractionPreview to check for similar products when data is extracted:

1. Add imports:
   - useState, useEffect (keep existing useTransition)
   - findSimilarProducts, SimilarProduct from @/lib/actions/similarity
   - SimilarProductsWarning from ./similar-products-warning

2. Add state:
   - similarProducts: SimilarProduct[] (default [])
   - similarityLoading: boolean (default true)

3. Add useEffect that runs when component mounts (or when extractedData changes):
   - Set similarityLoading to true
   - Call findSimilarProducts(extractedData.name, extractedData.sku)
   - If result.success and result.data, set similarProducts
   - Set similarityLoading to false
   - Dependencies: [extractedData.name, extractedData.sku]

4. Render SimilarProductsWarning:
   - Place ABOVE the form (after serverError div, before Name field)
   - Pass products={similarProducts} and isLoading={similarityLoading}

5. Keep all existing form functionality unchanged:
   - Form still works identically
   - User can still save even with warning (warn, don't block)
   - No changes to onSubmit behavior
  </action>
  <verify>
- ExtractionPreview imports similarity action and warning component
- useEffect calls findSimilarProducts on mount
- SimilarProductsWarning renders above the form
- Form submission still works (test: form still has submit button, onSubmit unchanged)
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ExtractionPreview shows similar products warning after extraction. Warning is informational only - users can still save the product.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server runs without console errors: `npm run dev`
3. Component structure:
   - SimilarProductsWarning is a self-contained warning display
   - ExtractionPreview orchestrates the similarity check
</verification>

<success_criteria>
- SimilarProductsWarning component exists and handles all states (loading, empty, with products)
- ExtractionPreview calls findSimilarProducts and displays warning
- Warning shows similarity percentage and vendor name for each match
- User can proceed with saving regardless of warning
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-comparison-engine/04-02-SUMMARY.md`
</output>
