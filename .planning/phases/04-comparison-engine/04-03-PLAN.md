---
phase: 04-comparison-engine
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/comparison/price-comparison-table.tsx
  - src/components/product/product-detail.tsx
autonomous: true

must_haves:
  truths:
    - "User can see all vendor prices for a product at a glance"
    - "Price comparison table shows vendor name, SKU, price, and similarity percentage"
    - "Current product is highlighted in the comparison table"
    - "Products are sorted by price (lowest first)"
  artifacts:
    - path: "src/components/comparison/price-comparison-table.tsx"
      provides: "Price comparison table component"
      exports: ["PriceComparisonTable"]
      min_lines: 40
    - path: "src/components/product/product-detail.tsx"
      provides: "Product detail with price comparison section"
      contains: "PriceComparisonTable"
  key_links:
    - from: "src/components/product/product-detail.tsx"
      to: "src/lib/actions/similarity.ts"
      via: "getProductPriceComparison import and call"
      pattern: "getProductPriceComparison"
    - from: "src/components/product/product-detail.tsx"
      to: "src/components/comparison/price-comparison-table.tsx"
      via: "component import and render"
      pattern: "PriceComparisonTable"
---

<objective>
Add price comparison view to product detail showing the same/similar product from all vendors.

Purpose: Users can see all vendor prices for a product at a glance. This implements COMP-01 and COMP-02 requirements - grouping similar products from different vendors and showing their prices side-by-side for easy comparison.

Output: PriceComparisonTable component and updated ProductDetail that fetches and displays price comparison data.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-comparison-engine/04-RESEARCH.md
@.planning/phases/04-comparison-engine/04-01-SUMMARY.md
@src/components/product/product-detail.tsx
@src/lib/actions/similarity.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PriceComparisonTable component</name>
  <files>src/components/comparison/price-comparison-table.tsx</files>
  <action>
Create a new client component that displays price comparison across vendors:

1. Mark as "use client"

2. Import ProductPriceComparison type from @/lib/actions/similarity

3. Props interface PriceComparisonTableProps:
   - products: ProductPriceComparison[]
   - currentProductId: string
   - isLoading: boolean

4. Helper function formatPrice(price: number | null):
   - Returns formatted string like "12,500 CZK" using toLocaleString('cs-CZ')
   - Returns "N/A" for null prices

5. Component implementation:
   - If isLoading, show skeleton/loading state with pulsing rows
   - If products.length <= 1, show message "No price comparison available" (only one vendor has this product)
   - Render table with columns: Vendor, SKU, Price, Match %
   - Highlight current product row (bg-accent/10 or similar)
   - Show "(current)" label next to current product's vendor
   - Price column right-aligned, font-medium for emphasis
   - Match % column shows Math.round(similarity * 100) + "%"

6. Styling:
   - Use border border-border rounded-lg overflow-hidden
   - thead with bg-muted
   - Consistent with existing table styling in the project
   - th/td padding: px-4 py-2
  </action>
  <verify>
- File exists at src/components/comparison/price-comparison-table.tsx
- Creates src/components/comparison directory if needed
- Exports PriceComparisonTable component
- Handles loading state with skeleton
- Handles single product (no comparison available)
- Shows table with all required columns
- Highlights current product
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
PriceComparisonTable component renders price comparison table sorted by price with current product highlighted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate price comparison into ProductDetail</name>
  <files>src/components/product/product-detail.tsx</files>
  <action>
Modify ProductDetail to fetch and display price comparison:

1. Add imports:
   - useState, useEffect from react
   - getProductPriceComparison, ProductPriceComparison from @/lib/actions/similarity
   - PriceComparisonTable from @/components/comparison/price-comparison-table

2. Add state:
   - comparisonProducts: ProductPriceComparison[] (default [])
   - comparisonLoading: boolean (default true)

3. Add useEffect to fetch comparison data:
   - Set comparisonLoading to true
   - Call getProductPriceComparison(product.id)
   - If result.success and result.data, set comparisonProducts
   - Set comparisonLoading to false
   - Dependencies: [product.id]

4. Add new Section 6 AFTER Regulatory Information (Section 5):
   - Section header: "Price Comparison" with same styling as other sections
   - Subheader text: "Same or similar product from other vendors"
   - Render PriceComparisonTable with products={comparisonProducts}, currentProductId={product.id}, isLoading={comparisonLoading}
   - NO border-b on this section (it's the last one)

5. Keep all existing sections unchanged
  </action>
  <verify>
- ProductDetail imports comparison components
- useEffect calls getProductPriceComparison on mount and when product.id changes
- New "Price Comparison" section appears after Regulatory Information
- PriceComparisonTable receives correct props
- All existing sections still render correctly
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ProductDetail shows price comparison section. Users can see all vendor prices for the same/similar product at a glance.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server runs without console errors: `npm run dev`
3. Component structure:
   - PriceComparisonTable is a reusable display component
   - ProductDetail handles data fetching and integration
</verification>

<success_criteria>
- PriceComparisonTable component exists and handles all states (loading, no comparison, with products)
- ProductDetail fetches price comparison and displays new section
- Table shows vendor, SKU, price, and similarity percentage
- Current product is visually highlighted
- Products sorted by price (lowest first, as returned by RPC)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-comparison-engine/04-03-SUMMARY.md`
</output>
