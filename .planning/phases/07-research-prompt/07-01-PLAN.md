---
phase: 07-research-prompt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/prompt-template.ts
  - src/components/product/research-prompt.tsx
  - src/components/product/product-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Product detail has Research Pricing button"
    - "Button generates structured prompt with product specs"
    - "User can copy prompt to clipboard with one click"
    - "User can open Perplexity in new tab"
    - "Copied state shows visual feedback for 2 seconds"
  artifacts:
    - path: "src/lib/utils/prompt-template.ts"
      provides: "Prompt generation function"
      exports: ["generateResearchPrompt"]
    - path: "src/components/product/research-prompt.tsx"
      provides: "Research prompt UI component"
      exports: ["ResearchPrompt"]
    - path: "src/components/product/product-detail.tsx"
      provides: "Product detail with research section"
      contains: "ResearchPrompt"
  key_links:
    - from: "src/components/product/research-prompt.tsx"
      to: "src/lib/utils/prompt-template.ts"
      via: "import generateResearchPrompt"
      pattern: "import.*generateResearchPrompt.*from.*prompt-template"
    - from: "src/components/product/product-detail.tsx"
      to: "src/components/product/research-prompt.tsx"
      via: "import ResearchPrompt"
      pattern: "import.*ResearchPrompt.*from.*research-prompt"
    - from: "src/components/product/research-prompt.tsx"
      to: "usehooks-ts"
      via: "useCopyToClipboard hook"
      pattern: "useCopyToClipboard"
---

<objective>
Implement Research Prompt feature for product detail view.

Purpose: Enable users to generate structured prompts for finding EU vendors and pricing via Perplexity AI. This completes the research workflow for procurement comparison.

Output:
- `src/lib/utils/prompt-template.ts` - Generates structured prompt from product data
- `src/components/product/research-prompt.tsx` - UI component with copy/open buttons
- Updated `src/components/product/product-detail.tsx` - Includes research section
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-research-prompt/07-RESEARCH.md

# Source files
@src/lib/types.ts
@src/components/product/product-detail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt template utility</name>
  <files>src/lib/utils/prompt-template.ts</files>
  <action>
Create `src/lib/utils/prompt-template.ts` with `generateResearchPrompt` function:

1. Import `ProductWithRelations` from `@/lib/types`

2. Export function `generateResearchPrompt(product: ProductWithRelations): string`

3. Build prompt with these sections (only include if data exists):
   - Header: "Find EU medical device distributors and pricing for:"
   - Product name (always)
   - Manufacturer name (if exists)
   - Manufacturer SKU/Part Number (if exists)
   - Current vendor SKU with vendor name (if both exist)
   - Description (if exists, truncate to 200 chars if longer)
   - EMDN Category name (if exists)
   - Material name (if exists)
   - MDR Classification (if exists)
   - CE Marked status (only if true)
   - UDI-DI (if exists)
   - Request section asking for:
     1. EU distributors/vendors selling this exact product
     2. Current pricing in EUR with vendor contact details
     3. Alternative equivalent products if exact match unavailable
   - Focus region: Czech Republic and surrounding EU countries

4. Use array of lines joined by newline for clean formatting

Refer to 07-RESEARCH.md Pattern 3 for exact implementation pattern.
  </action>
  <verify>
File exists at `src/lib/utils/prompt-template.ts`.
TypeScript compiles: `npx tsc --noEmit src/lib/utils/prompt-template.ts`
  </verify>
  <done>
Function exported, accepts ProductWithRelations, returns formatted string prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ResearchPrompt component</name>
  <files>src/components/product/research-prompt.tsx</files>
  <action>
Create `src/components/product/research-prompt.tsx` as client component:

1. Add `'use client'` directive at top

2. Import dependencies:
   - `useState`, `useEffect` from 'react'
   - `useCopyToClipboard` from 'usehooks-ts'
   - `Copy`, `Check`, `ExternalLink` from 'lucide-react'
   - `ProductWithRelations` from '@/lib/types'
   - `generateResearchPrompt` from '@/lib/utils/prompt-template'

3. Props interface: `{ product: ProductWithRelations }`

4. Component state:
   - `[, copy] = useCopyToClipboard()` for clipboard
   - `[copied, setCopied] = useState(false)` for feedback

5. Generate prompt: `const prompt = generateResearchPrompt(product)`

6. useEffect for copied state reset after 2 seconds (with cleanup)

7. handleCopy function:
   - Call `copy(prompt)` and check success
   - Set `copied = true` on success

8. handleOpenPerplexity function:
   - `window.open('https://www.perplexity.ai/', '_blank', 'noopener,noreferrer')`
   - Use base URL since prompt may be too long for query param

9. Render:
   - Container div with `space-y-4`
   - Prompt preview in `bg-muted/50 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap max-h-64 overflow-y-auto`
   - Button row with `flex gap-3`:
     - Copy button: accent background, shows Check icon + "Copied!" when copied, Copy icon + "Copy Prompt" otherwise
     - Open Perplexity button: border style, ExternalLink icon + "Open Perplexity"

Button classes match existing project patterns:
- Copy: `flex items-center gap-2 px-4 py-2 bg-accent text-accent-foreground rounded-md hover:bg-accent/90 transition-colors`
- Perplexity: `flex items-center gap-2 px-4 py-2 border border-border rounded-md hover:bg-muted transition-colors`

Refer to 07-RESEARCH.md Code Examples section for full implementation.
  </action>
  <verify>
File exists at `src/components/product/research-prompt.tsx`.
TypeScript compiles: `npx tsc --noEmit src/components/product/research-prompt.tsx`
  </verify>
  <done>
Component renders prompt preview, copy button with feedback state, and Perplexity link button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ResearchPrompt into ProductDetail</name>
  <files>src/components/product/product-detail.tsx</files>
  <action>
Update `src/components/product/product-detail.tsx`:

1. Add import: `import { ResearchPrompt } from './research-prompt'`

2. After Section 6 (Price Comparison), add Section 7:

```tsx
{/* Section 7: Research EU Pricing */}
<div className="pt-2 border-t-2 border-blue-border">
  <p className="text-sm font-medium text-blue-subtle uppercase tracking-wide mb-1">
    Research EU Pricing
  </p>
  <p className="text-sm text-muted-foreground mb-3">
    Generate a prompt to find EU vendors and pricing via Perplexity AI
  </p>
  <ResearchPrompt product={product} />
</div>
```

Note: Uses `border-blue-border` and `text-blue-subtle` to visually distinguish from Price Comparison (green) section. If these classes don't exist in Tailwind config, use `border-sky-200` and `text-sky-600` as fallbacks.

The section should appear at the bottom of the product detail, after Price Comparison.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/components/product/product-detail.tsx`
Dev server shows no errors: `npm run dev` (check browser console)
  </verify>
  <done>
ProductDetail includes Research EU Pricing section with ResearchPrompt component.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check:** `npm run build` completes without errors

2. **Visual verification:** Navigate to any product detail view
   - Research EU Pricing section visible at bottom
   - Prompt preview shows structured text with product data
   - Copy button changes to "Copied!" for 2 seconds after click
   - Perplexity button opens new tab to perplexity.ai

3. **Functional verification:**
   - Copy prompt, paste in text editor - confirms clipboard works
   - Check prompt includes: product name, manufacturer (if exists), category, MDR class
   - Check prompt ends with request for EU vendors and pricing
</verification>

<success_criteria>
- [x] RSRCH-01: Product detail has "Research Pricing" button (Research EU Pricing section exists)
- [x] RSRCH-02: Prompt includes product specs, manufacturer, SKU (generateResearchPrompt includes all fields)
- [x] RSRCH-03: One-click copy to clipboard (Copy Prompt button with useCopyToClipboard)
- [x] RSRCH-04: Open Perplexity in new tab (Open Perplexity button with window.open)
- [x] RSRCH-05: Prompt format documented (prompt template is structured, request section is consistent)
</success_criteria>

<output>
After completion, create `.planning/phases/07-research-prompt/07-01-SUMMARY.md`
</output>
