---
phase: 08-streaming-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/chat/chat-widget.tsx
  - src/components/chat/chat-panel.tsx
  - src/components/chat/chat-input.tsx
  - src/components/chat/message-list.tsx
  - src/components/chat/message-bubble.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see floating Chat button in bottom-right corner"
    - "Clicking Chat button expands into chat panel with smooth animation"
    - "User can type a message and send it with Enter key or send button"
    - "AI response streams incrementally into the chat"
    - "User can close panel with X button"
    - "Closing panel during streaming aborts the connection cleanly"
  artifacts:
    - path: "src/components/chat/chat-widget.tsx"
      provides: "Main widget with button/panel toggle"
      min_lines: 40
    - path: "src/components/chat/chat-panel.tsx"
      provides: "Chat panel with useChat integration"
      min_lines: 50
    - path: "src/components/chat/chat-input.tsx"
      provides: "Auto-expanding textarea with send button"
      min_lines: 40
    - path: "src/components/chat/message-list.tsx"
      provides: "Scrollable message container"
      min_lines: 20
    - path: "src/components/chat/message-bubble.tsx"
      provides: "Individual message with markdown rendering"
      min_lines: 30
  key_links:
    - from: "src/components/chat/chat-panel.tsx"
      to: "/api/chat"
      via: "useChat hook default endpoint"
      pattern: "useChat"
    - from: "src/components/chat/chat-panel.tsx"
      to: "stop function"
      via: "cleanup effect on close"
      pattern: "stop\\(\\)"
    - from: "src/components/chat/message-bubble.tsx"
      to: "react-markdown"
      via: "Markdown component import"
      pattern: "from 'react-markdown'"
    - from: "src/app/page.tsx"
      to: "src/components/chat/chat-widget.tsx"
      via: "ChatWidget import and render"
      pattern: "<ChatWidget"
---

<objective>
Build the complete chat widget UI with streaming message display.

Purpose: Create the user-facing chat interface that transforms from a floating button into an expanded panel. Users can send messages and see AI responses stream in real-time with full markdown rendering.

Output: Fully functional chat widget integrated into the catalog page, featuring animated open/close, auto-expanding input, and streaming markdown messages.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-streaming-foundation/08-CONTEXT.md
@.planning/phases/08-streaming-foundation/08-RESEARCH.md
@.planning/phases/08-streaming-foundation/08-01-SUMMARY.md
@src/app/page.tsx
@src/app/globals.css
@src/components/catalog-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create message display components</name>
  <files>src/components/chat/message-bubble.tsx, src/components/chat/message-list.tsx</files>
  <action>
Create the message display components:

**src/components/chat/message-bubble.tsx:**
```typescript
'use client';

import Markdown from 'react-markdown';
import remarkGfm from 'remark-gfm';

interface MessageBubbleProps {
  content: string;
  role: 'user' | 'assistant';
}

export function MessageBubble({ content, role }: MessageBubbleProps) {
  const isUser = role === 'user';

  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-3`}>
      <div
        className={`max-w-[85%] px-4 py-2.5 ${
          isUser
            ? 'bg-accent text-accent-foreground rounded-2xl rounded-br-md'
            : 'bg-muted text-foreground rounded-2xl rounded-bl-md'
        }`}
      >
        {isUser ? (
          <p className="whitespace-pre-wrap text-sm">{content}</p>
        ) : (
          <Markdown
            remarkPlugins={[remarkGfm]}
            className="prose prose-sm max-w-none text-sm"
            components={{
              // Paragraph styling
              p: ({ children }) => <p className="mb-2 last:mb-0">{children}</p>,
              // Table styling for product comparisons
              table: ({ children }) => (
                <div className="overflow-x-auto my-2 -mx-2">
                  <table className="min-w-full border-collapse text-xs">
                    {children}
                  </table>
                </div>
              ),
              th: ({ children }) => (
                <th className="border border-border bg-table-header px-2 py-1.5 text-left font-medium">
                  {children}
                </th>
              ),
              td: ({ children }) => (
                <td className="border border-border px-2 py-1.5">{children}</td>
              ),
              // List styling
              ul: ({ children }) => <ul className="list-disc pl-4 mb-2 space-y-1">{children}</ul>,
              ol: ({ children }) => <ol className="list-decimal pl-4 mb-2 space-y-1">{children}</ol>,
              li: ({ children }) => <li className="text-sm">{children}</li>,
              // Code styling (inline and block)
              code: ({ className, children }) => {
                const isBlock = className?.includes('language-');
                return isBlock ? (
                  <code className={`block bg-background/50 p-2 rounded text-xs overflow-x-auto ${className}`}>
                    {children}
                  </code>
                ) : (
                  <code className="bg-background/50 px-1 py-0.5 rounded text-xs">{children}</code>
                );
              },
              // Strong/bold
              strong: ({ children }) => <strong className="font-semibold">{children}</strong>,
            }}
          />
        )}
      </div>
    </div>
  );
}
```

**src/components/chat/message-list.tsx:**
```typescript
'use client';

import { useRef, useEffect } from 'react';
import { MessageBubble } from './message-bubble';
import type { UIMessage } from 'ai';

interface MessageListProps {
  messages: UIMessage[];
  isStreaming: boolean;
}

export function MessageList({ messages, isStreaming }: MessageListProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const bottomRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom when new messages arrive or content streams
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isStreaming]);

  return (
    <div ref={containerRef} className="flex-1 overflow-y-auto px-4 py-4">
      {messages.length === 0 ? (
        <div className="h-full flex items-center justify-center text-muted-foreground text-sm">
          <p>Ask me anything about medical devices...</p>
        </div>
      ) : (
        messages.map((message) => (
          <MessageBubble
            key={message.id}
            content={typeof message.content === 'string' ? message.content : ''}
            role={message.role as 'user' | 'assistant'}
          />
        ))
      )}
      <div ref={bottomRef} />
    </div>
  );
}
```

Key implementation notes:
- Use `remarkGfm` plugin for tables (critical for future product comparisons)
- User bubbles are green (accent), AI bubbles are muted gray
- Custom Markdown components match the app's design system (table-header, border colors)
- Auto-scroll uses smooth behavior, triggers on both new messages and streaming updates
- Empty state shows helpful placeholder text
  </action>
  <verify>
```bash
cat src/components/chat/message-bubble.tsx
cat src/components/chat/message-list.tsx
```
Both files exist with proper imports (react-markdown, remark-gfm, UIMessage type).
  </verify>
  <done>MessageBubble renders markdown for AI messages and plain text for user messages. MessageList displays messages with auto-scroll.</done>
</task>

<task type="auto">
  <name>Task 2: Create chat input and panel components</name>
  <files>src/components/chat/chat-input.tsx, src/components/chat/chat-panel.tsx</files>
  <action>
Create the input and panel components:

**src/components/chat/chat-input.tsx:**
```typescript
'use client';

import { useRef, useEffect, useState, useCallback } from 'react';
import { ArrowUp } from 'lucide-react';

interface ChatInputProps {
  onSubmit: (text: string) => void;
  disabled?: boolean;
}

export function ChatInput({ onSubmit, disabled }: ChatInputProps) {
  const [value, setValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  // Auto-expand textarea as user types
  useEffect(() => {
    const textarea = textareaRef.current;
    if (textarea) {
      // Reset height to auto to get correct scrollHeight
      textarea.style.height = 'auto';
      // Set to scrollHeight, capped at 150px
      textarea.style.height = `${Math.min(textarea.scrollHeight, 150)}px`;
    }
  }, [value]);

  const handleSubmit = useCallback(() => {
    const trimmed = value.trim();
    if (trimmed && !disabled) {
      onSubmit(trimmed);
      setValue('');
      // Reset height after clearing
      if (textareaRef.current) {
        textareaRef.current.style.height = 'auto';
      }
    }
  }, [value, disabled, onSubmit]);

  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
    // Shift+Enter allows newline (default behavior)
  }, [handleSubmit]);

  const showSendButton = value.trim().length > 0;

  return (
    <div className="border-t border-border px-4 py-3">
      <div className="flex items-end gap-2">
        <textarea
          ref={textareaRef}
          value={value}
          onChange={(e) => setValue(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Ask about products..."
          disabled={disabled}
          rows={1}
          className="flex-1 resize-none overflow-hidden bg-muted rounded-lg px-3 py-2.5 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-accent/50 disabled:opacity-50"
          style={{ maxHeight: '150px' }}
        />
        {showSendButton && (
          <button
            onClick={handleSubmit}
            disabled={disabled}
            className="p-2.5 bg-accent text-accent-foreground rounded-lg hover:bg-green-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed shrink-0"
            aria-label="Send message"
          >
            <ArrowUp className="w-4 h-4" />
          </button>
        )}
      </div>
    </div>
  );
}
```

**src/components/chat/chat-panel.tsx:**
```typescript
'use client';

import { useEffect } from 'react';
import { useChat } from '@ai-sdk/react';
import { MessageList } from './message-list';
import { ChatInput } from './chat-input';

interface ChatPanelProps {
  isOpen: boolean;
}

export function ChatPanel({ isOpen }: ChatPanelProps) {
  const { messages, sendMessage, status, stop } = useChat();

  const isStreaming = status === 'streaming';

  // CRITICAL: Cleanup on close - abort any active streaming
  // This prevents memory leaks and orphan server processes
  useEffect(() => {
    if (!isOpen && isStreaming) {
      stop();
    }
  }, [isOpen, isStreaming, stop]);

  // Also cleanup on unmount (safety net)
  useEffect(() => {
    return () => {
      if (status === 'streaming') {
        stop();
      }
    };
  }, [status, stop]);

  const handleSubmit = (text: string) => {
    if (text.trim()) {
      sendMessage({ content: text });
    }
  };

  return (
    <div className="flex flex-col h-full">
      <MessageList messages={messages} isStreaming={isStreaming} />
      <ChatInput onSubmit={handleSubmit} disabled={isStreaming} />
    </div>
  );
}
```

Key implementation notes:
- ChatInput: Auto-expanding textarea with height reset pattern (set to 'auto' THEN scrollHeight to avoid stuck heights)
- ChatInput: Send button only appears when there's text (per CONTEXT.md)
- ChatInput: Enter sends, Shift+Enter allows newlines
- ChatPanel: Uses `useChat` hook which defaults to `/api/chat` endpoint
- ChatPanel: TWO cleanup effects - one for close, one for unmount (belt and suspenders for memory leaks)
- ChatPanel: Disables input during streaming to prevent double-sends
  </action>
  <verify>
```bash
cat src/components/chat/chat-input.tsx
cat src/components/chat/chat-panel.tsx
```
Both files exist. ChatPanel imports useChat from @ai-sdk/react and has cleanup effects with stop() calls.
  </verify>
  <done>ChatInput has auto-expanding textarea with conditional send button. ChatPanel integrates useChat hook with proper cleanup on close and unmount.</done>
</task>

<task type="auto">
  <name>Task 3: Create chat widget and integrate into page</name>
  <files>src/components/chat/chat-widget.tsx, src/app/page.tsx</files>
  <action>
Create the main widget component and integrate into the catalog page:

**src/components/chat/chat-widget.tsx:**
```typescript
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { MessageSquare, X } from 'lucide-react';
import { ChatPanel } from './chat-panel';

export function ChatWidget() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="fixed bottom-4 right-4 z-50">
      <AnimatePresence mode="wait" initial={false}>
        {!isOpen ? (
          <motion.button
            key="chat-button"
            layoutId="chat-container"
            onClick={() => setIsOpen(true)}
            className="flex items-center gap-2 px-4 py-2.5 bg-accent text-accent-foreground rounded-full shadow-lg hover:bg-green-hover transition-colors"
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
          >
            <MessageSquare className="w-5 h-5" />
            <span className="font-medium">Chat</span>
          </motion.button>
        ) : (
          <motion.div
            key="chat-panel"
            layoutId="chat-container"
            className="w-[450px] h-[600px] bg-background rounded-xl shadow-lg border border-border overflow-hidden flex flex-col"
            transition={{ type: 'spring', damping: 25, stiffness: 300 }}
          >
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-border bg-gradient-to-b from-background to-muted/30">
              <div className="flex items-center gap-2">
                <div className="w-7 h-7 rounded-lg bg-green-light border border-green-border/60 flex items-center justify-center">
                  <MessageSquare className="w-4 h-4 text-accent" />
                </div>
                <h2 className="font-semibold text-sm">MedCatalog Assistant</h2>
              </div>
              <button
                onClick={() => setIsOpen(false)}
                className="p-1.5 rounded-md hover:bg-muted transition-colors"
                aria-label="Close chat"
              >
                <X className="w-4 h-4 text-muted-foreground" />
              </button>
            </div>

            {/* Chat content */}
            <ChatPanel isOpen={isOpen} />
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
```

**Update src/app/page.tsx:**

Add the ChatWidget import at the top with other imports:
```typescript
import { ChatWidget } from "@/components/chat/chat-widget";
```

Add the ChatWidget component at the end of the main content, just before the closing `</main>` tag:
```typescript
      {/* Chat Widget */}
      <ChatWidget />
    </main>
```

The full return statement should end like:
```typescript
        </div>
      </div>

      {/* Chat Widget */}
      <ChatWidget />
    </main>
  );
}
```

Key implementation notes:
- Motion layoutId="chat-container" enables smooth button-to-panel transformation
- AnimatePresence with mode="wait" ensures clean exit animations
- Conditional is INSIDE AnimatePresence (not outside - common pitfall)
- Panel size 450x600px per CONTEXT.md
- Header matches app design (green accent icon, subtle gradient)
- z-50 ensures widget floats above catalog content
- ChatWidget is a client component, rendered inside the server component page (valid pattern)
  </action>
  <verify>
```bash
cat src/components/chat/chat-widget.tsx
grep -n "ChatWidget" src/app/page.tsx
```
ChatWidget file exists with AnimatePresence and layoutId. Page.tsx imports and renders ChatWidget.
  </verify>
  <done>ChatWidget transforms from pill button to 450x600 panel with smooth animation. Widget is rendered on the catalog page.</done>
</task>

</tasks>

<verification>
Full phase verification:

1. **All files created:**
   ```bash
   ls -la src/components/chat/
   ```
   Should show: chat-widget.tsx, chat-panel.tsx, chat-input.tsx, message-list.tsx, message-bubble.tsx

2. **Build check:**
   ```bash
   npm run build
   ```
   Should complete without TypeScript errors.

3. **Manual functional test:**
   - Start dev server: `npm run dev`
   - Open http://localhost:3000
   - Verify "Chat" pill button visible in bottom-right corner
   - Click button - should expand into 450x600 panel with smooth animation
   - Type a message and press Enter - should send
   - AI response should stream in (text appears incrementally)
   - Click X button - panel should animate closed
   - If streaming was in progress, should abort cleanly (no console errors)

4. **Keyboard shortcuts:**
   - Enter sends message
   - Shift+Enter creates newline in input
   - Send button only appears when text is entered

5. **Memory leak check:**
   - Open DevTools Network tab
   - Send a message, then close panel while streaming
   - Verify SSE connection is terminated (not hanging open)
</verification>

<success_criteria>
- Floating Chat button visible in bottom-right of catalog page
- Clicking Chat transforms button into 450x600 panel with smooth animation
- Panel has header with "MedCatalog Assistant" title and X close button
- User can type message in auto-expanding textarea
- Enter sends message, Shift+Enter creates newline
- Send button (arrow icon) appears only when text is entered
- AI responses stream incrementally (not all at once)
- User messages appear right-aligned in green bubbles
- AI messages appear left-aligned in gray bubbles with markdown rendering
- Closing panel during streaming aborts connection (no console errors, no memory leaks)
- npm run build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-streaming-foundation/08-02-SUMMARY.md`
</output>
