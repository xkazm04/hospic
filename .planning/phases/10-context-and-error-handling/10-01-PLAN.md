---
phase: 10-context-and-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/chat/errors.ts
  - src/lib/chat/constants.ts
  - src/app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "API errors return classified status codes (429 for rate limit, 503 for retryable, 500 for generic)"
    - "Error classification utility correctly identifies rate limits vs retryable vs generic errors"
    - "MAX_MESSAGES constant exists for use by UI components"
  artifacts:
    - path: "src/lib/chat/errors.ts"
      provides: "Error classification utilities"
      exports: ["classifyError", "ClassifiedError"]
    - path: "src/lib/chat/constants.ts"
      provides: "Chat configuration constants"
      contains: "MAX_MESSAGES = 50"
    - path: "src/app/api/chat/route.ts"
      provides: "Chat API with error handling"
      contains: "APICallError.isInstance"
  key_links:
    - from: "src/app/api/chat/route.ts"
      to: "ai (APICallError)"
      via: "error classification"
      pattern: "APICallError\\.isInstance"
---

<objective>
Add error classification infrastructure to the chat system - utilities for classifying errors into user-friendly categories and server-side error handling in the API route.

Purpose: Enable graceful error handling by distinguishing rate limits (no retry), network errors (retryable), and generic errors. This foundation is required before the UI can display appropriate error messages.

Output: Error classification utility (errors.ts), updated constants (MAX_MESSAGES), and API route with try-catch error handling.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-context-and-error-handling/10-CONTEXT.md
@.planning/phases/10-context-and-error-handling/10-RESEARCH.md
@src/lib/chat/constants.ts
@src/app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error classification utilities and update constants</name>
  <files>src/lib/chat/errors.ts, src/lib/chat/constants.ts</files>
  <action>
Create `src/lib/chat/errors.ts` with:

1. `ClassifiedError` interface:
   - `userMessage: string` - Conversational tone per CONTEXT.md
   - `isRetryable: boolean` - True for network/timeout, false for rate limits

2. `classifyError(error: unknown): ClassifiedError` function:
   - Import `APICallError` from 'ai'
   - Check `APICallError.isInstance(error)` first
   - If statusCode === 429: return "Too many requests. Please wait a moment and try again." with isRetryable: false
   - If error.isRetryable: return "Hmm, something went wrong on my end. Let me try again?" with isRetryable: true
   - Check for network-related strings in error.message (network, timeout, abort): return "Connection interrupted. Let me try again?" with isRetryable: true
   - Default fallback: "Something went wrong. Please try again." with isRetryable: true

3. Error message templates as exported constants:
   - `ERROR_RATE_LIMIT`
   - `ERROR_NETWORK`
   - `ERROR_GENERIC`

Update `src/lib/chat/constants.ts` to add:
- `MAX_MESSAGES = 50` - Per CONTEXT.md hard cap
- `CHAT_FULL_MESSAGE = "Chat full. Clear to continue."` - Per CONTEXT.md blocking message
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/chat/errors.ts src/lib/chat/constants.ts`
  </verify>
  <done>
classifyError function exported and handles rate limit (429), retryable, network, and generic error cases. MAX_MESSAGES constant available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to API route</name>
  <files>src/app/api/chat/route.ts</files>
  <action>
Wrap the `streamText` call in a try-catch block:

1. Import `APICallError` from 'ai'

2. In catch block, classify the error:
   - If `APICallError.isInstance(error)` and `statusCode === 429`:
     Return `new Response('Rate limited', { status: 429 })`
   - If `APICallError.isInstance(error)` and `error.isRetryable`:
     Return `new Response('Retryable error', { status: 503 })`
   - Default: Return `new Response('Server error', { status: 500 })`

3. Add `console.error('[Chat API Error]', error)` in catch block for debugging

Keep the existing streamText config unchanged (model, system, messages, tools, stopWhen, abortSignal).

Note: The Response body text is for debugging - the client uses status codes to classify errors.
  </action>
  <verify>
Build succeeds: `npm run build`
Manual test: Start dev server, temporarily throw an error in route.ts, verify appropriate status code returned
  </verify>
  <done>
API route catches errors and returns appropriate HTTP status codes: 429 for rate limits, 503 for retryable errors, 500 for generic errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without TypeScript errors
2. `src/lib/chat/errors.ts` exports classifyError function
3. `src/lib/chat/constants.ts` contains MAX_MESSAGES = 50
4. `src/app/api/chat/route.ts` has try-catch with APICallError handling
</verification>

<success_criteria>
- Error classification utility distinguishes rate limits (not retryable) from other errors (retryable)
- API route returns 429 for rate limits, 503 for retryable errors, 500 for generic
- MAX_MESSAGES constant is 50 per CONTEXT.md requirement
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-context-and-error-handling/10-01-SUMMARY.md`
</output>
