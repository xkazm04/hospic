---
phase: 11-external-web-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/chat/tools.ts
  - src/lib/chat/constants.ts
  - src/app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "User can request web search for EU alternatives with explicit trigger"
    - "External search returns results without breaking existing catalog search tools"
    - "Response includes source URLs when search finds results"
  artifacts:
    - path: "src/lib/chat/tools.ts"
      provides: "searchExternalProducts tool definition"
      contains: "searchExternalProducts"
    - path: "src/lib/chat/constants.ts"
      provides: "Updated system prompt with web search capability"
      contains: "searchExternalProducts"
    - path: "src/app/api/chat/route.ts"
      provides: "Tool registered in API route"
      contains: "searchExternalProducts"
  key_links:
    - from: "src/lib/chat/tools.ts"
      to: "google.tools.googleSearch"
      via: "isolated generateText call inside tool execute"
      pattern: "google\\.tools\\.googleSearch"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/chat/tools.ts"
      via: "import searchExternalProducts"
      pattern: "searchExternalProducts"
---

<objective>
Create the external web search tool infrastructure for finding EU medical device alternatives via Gemini Google Search grounding.

Purpose: Enable users to discover EU market alternatives not in the catalog by leveraging Gemini's web search grounding feature.

Output: Working `searchExternalProducts` tool that returns web-sourced results with source citations.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-external-web-search/11-CONTEXT.md
@.planning/phases/11-external-web-search/11-RESEARCH.md

@src/lib/chat/tools.ts
@src/lib/chat/constants.ts
@src/app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create searchExternalProducts tool with isolated grounding</name>
  <files>src/lib/chat/tools.ts</files>
  <action>
Add the `searchExternalProducts` tool to tools.ts using the isolated wrapper pattern from RESEARCH.md.

CRITICAL: Cannot combine google.tools.googleSearch() with custom tools in same request. Must use isolated generateText call inside the tool's execute function.

Implementation:
1. Import `generateText` from 'ai' (already imported? check)
2. Import `createGoogleGenerativeAI` - reuse existing pattern or create local instance
3. Define tool with inputSchema:
   - productName: z.string() - Name of catalog product to find alternatives for
   - productCategory: z.string().optional() - EMDN category for context
   - vendorName: z.string().optional() - Current vendor for exclusion context

4. In execute function:
   - Build search context: productName + productCategory + "orthopedic medical device EU market CE marked alternatives"
   - REQUIRED: Search context string MUST include 'EU market' and 'CE marked' to target European medical device market
   - Make isolated generateText call with:
     - model: google('gemini-2.5-flash')
     - tools: { google_search: google.tools.googleSearch({}) }
     - prompt: Request 3-5 EU market alternatives with product names and source URLs
     - temperature: 1.0 (recommended for grounding)
   - Handle undefined groundingMetadata gracefully:
     - Extract: `const groundingMetadata = response.providerMetadata?.google?.groundingMetadata`
     - If groundingMetadata is undefined: return { hasResults: false, summary: 'Unable to retrieve web search results.', sources: [], searchQueries: [] }
   - When groundingMetadata exists:
     - Map groundingChunks to sources array with: url, title, domain (extracted via new URL().hostname)
     - Filter out sources with invalid/empty URLs
     - Limit to 5 sources per CONTEXT.md
     - Return: { summary: text, sources, searchQueries, hasResults: sources.length > 0 }

5. Error handling:
   - Wrap entire execute in try/catch
   - On any error, return: { hasResults: false, summary: 'Web search failed. Please try again.', sources: [], searchQueries: [] }
   - Log error to console for debugging

Description for AI triggering:
"Search the web for EU medical device market alternatives to a catalog product. Only use when user explicitly asks for 'alternatives' or 'search the web'. Must reference a specific catalog product."

Do NOT modify existing tools (searchProducts, comparePrices, suggestCategories).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Tool exports correctly: grep for "export const searchExternalProducts"
Undefined handling: grep for "providerMetadata?.google?.groundingMetadata" and verify fallback return
  </verify>
  <done>
searchExternalProducts tool defined with isolated generateText pattern, inputSchema accepts productName/productCategory/vendorName, search context includes 'EU market' and 'CE marked', gracefully handles undefined groundingMetadata by returning hasResults: false, returns summary + sources array with url/title/domain
  </done>
</task>

<task type="auto">
  <name>Task 2: Update system prompt and register tool in API route</name>
  <files>src/lib/chat/constants.ts, src/app/api/chat/route.ts</files>
  <action>
Update system prompt in constants.ts:

1. Add to capabilities section:
   "- Search the web for EU market alternatives using the searchExternalProducts tool"

2. Add guideline for when to use:
   "- When user asks for 'alternatives' or to 'search the web' for a catalog product, use searchExternalProducts tool"
   "- Before web search, confirm: 'Searching the web for alternatives to [product]...'"

3. REMOVE from limitations section:
   "- Cannot search external websites (catalog only)"

4. Add note about external results:
   "- External search results are leads to investigate, not verified products in our catalog"

Update API route in route.ts:

1. Import searchExternalProducts from '@/lib/chat/tools'
2. Add to tools object in streamText call:
   tools: {
     searchProducts,
     comparePrices,
     suggestCategories,
     searchExternalProducts,  // Add this
   }

No other changes needed - existing stepCountIs(3) and error handling apply.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
System prompt includes searchExternalProducts: grep SYSTEM_PROMPT in constants.ts
Tool registered: grep searchExternalProducts in route.ts
  </verify>
  <done>
System prompt updated with web search capability and guidelines, searchExternalProducts registered in API route tools object, "cannot search external" limitation removed
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify tool execution with automated tests</name>
  <files>N/A - verification only</files>
  <action>
Verify the tool executes correctly and returns valid structure in all cases:

1. Start dev server: `npm run dev`

2. Test tool returns valid structure via curl (bypasses UI, tests API directly):
```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"find alternatives to titanium hip stem on EU market"}]}'
```

3. Verify response structure includes tool call with valid output schema:
   - Response should be streaming text
   - Look for tool invocation in response
   - Tool output (when complete) should have: summary, sources (array), hasResults (boolean), searchQueries (array)

4. Test existing tools still work:
```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"search for knee implants"}]}'
```
   - Should invoke searchProducts tool, not searchExternalProducts

5. TypeScript verification that tool signature is correct:
   - `npx tsc --noEmit` - no errors
   - `grep -A5 "searchExternalProducts" src/lib/chat/tools.ts` - verify return type

6. Verify graceful handling when grounding fails:
   - Check console output during curl test for any errors
   - Tool should return hasResults: false, not throw error

Expected outcomes:
- No 500 errors from API
- Tool invocation appears in response
- Response includes expected fields (summary, sources, hasResults, searchQueries)
- Existing tools (searchProducts) still trigger correctly on non-alternative queries
  </action>
  <verify>
Dev server starts: `npm run dev` exits 0 or stays running
TypeScript compiles: `npx tsc --noEmit` exits 0
API responds to curl: curl returns 200 status with streaming response
Tool output has valid schema: response contains summary, sources, hasResults fields
Existing tools work: searchProducts triggers on "search for knee implants"
  </verify>
  <done>
searchExternalProducts tool executes when user requests alternatives, returns valid response structure with summary/sources/hasResults/searchQueries in all cases (success and failure), existing catalog tools still function correctly, no API errors
  </done>
</task>

</tasks>

<verification>
All checks pass:
- [ ] TypeScript compiles without errors
- [ ] searchExternalProducts exported from tools.ts
- [ ] Tool uses isolated generateText call (not mixed with other tools)
- [ ] Search context includes 'EU market' and 'CE marked' strings
- [ ] Undefined groundingMetadata returns hasResults: false gracefully
- [ ] System prompt describes web search capability
- [ ] Tool registered in API route
- [ ] Curl test: API returns valid structure without 500 errors
- [ ] Curl test: existing searchProducts tool still works
</verification>

<success_criteria>
1. User can type "find alternatives to [product] on EU market" and tool executes
2. Tool uses isolated Gemini call with googleSearch grounding (not mixed with custom tools)
3. Response includes summary text and sources array with url/title/domain
4. Search context explicitly includes 'EU market' and 'CE marked' to target European medical device market
5. Tool returns valid structure (hasResults: false) when grounding metadata is undefined
6. Existing tools (searchProducts, comparePrices, suggestCategories) still work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-external-web-search/11-01-SUMMARY.md`
</output>
