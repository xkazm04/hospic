---
phase: 11-external-web-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/chat/tools.ts
  - src/lib/chat/constants.ts
  - src/app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "User can request web search for EU alternatives with explicit trigger"
    - "Search uses Gemini Google Search grounding isolated from custom tools"
    - "Response includes source URLs from grounding metadata"
  artifacts:
    - path: "src/lib/chat/tools.ts"
      provides: "searchExternalProducts tool definition"
      contains: "searchExternalProducts"
    - path: "src/lib/chat/constants.ts"
      provides: "Updated system prompt with web search capability"
      contains: "searchExternalProducts"
    - path: "src/app/api/chat/route.ts"
      provides: "Tool registered in API route"
      contains: "searchExternalProducts"
  key_links:
    - from: "src/lib/chat/tools.ts"
      to: "google.tools.googleSearch"
      via: "isolated generateText call inside tool execute"
      pattern: "google\\.tools\\.googleSearch"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/chat/tools.ts"
      via: "import searchExternalProducts"
      pattern: "searchExternalProducts"
---

<objective>
Create the external web search tool infrastructure for finding EU medical device alternatives via Gemini Google Search grounding.

Purpose: Enable users to discover EU market alternatives not in the catalog by leveraging Gemini's web search grounding feature.

Output: Working `searchExternalProducts` tool that returns web-sourced results with source citations.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-external-web-search/11-CONTEXT.md
@.planning/phases/11-external-web-search/11-RESEARCH.md

@src/lib/chat/tools.ts
@src/lib/chat/constants.ts
@src/app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create searchExternalProducts tool with isolated grounding</name>
  <files>src/lib/chat/tools.ts</files>
  <action>
Add the `searchExternalProducts` tool to tools.ts using the isolated wrapper pattern from RESEARCH.md.

CRITICAL: Cannot combine google.tools.googleSearch() with custom tools in same request. Must use isolated generateText call inside the tool's execute function.

Implementation:
1. Import `generateText` from 'ai' (already imported? check)
2. Import `createGoogleGenerativeAI` - reuse existing pattern or create local instance
3. Define tool with inputSchema:
   - productName: z.string() - Name of catalog product to find alternatives for
   - productCategory: z.string().optional() - EMDN category for context
   - vendorName: z.string().optional() - Current vendor for exclusion context

4. In execute function:
   - Build search context: productName + productCategory + "orthopedic medical device EU CE marked"
   - Make isolated generateText call with:
     - model: google('gemini-2.5-flash')
     - tools: { google_search: google.tools.googleSearch({}) }
     - prompt: Request 3-5 EU market alternatives with product names and source URLs
     - temperature: 1.0 (recommended for grounding)
   - Extract groundingMetadata from providerMetadata.google
   - Map groundingChunks to sources array with: url, title, domain (extracted via new URL().hostname)
   - Limit to 5 sources per CONTEXT.md
   - Return: { summary: text, sources, searchQueries, hasResults: sources.length > 0 }

Description for AI triggering:
"Search the web for EU medical device market alternatives to a catalog product. Only use when user explicitly asks for 'alternatives' or 'search the web'. Must reference a specific catalog product."

Do NOT modify existing tools (searchProducts, comparePrices, suggestCategories).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Tool exports correctly: grep for "export const searchExternalProducts"
  </verify>
  <done>
searchExternalProducts tool defined with isolated generateText pattern, inputSchema accepts productName/productCategory/vendorName, returns summary + sources array with url/title/domain
  </done>
</task>

<task type="auto">
  <name>Task 2: Update system prompt and register tool in API route</name>
  <files>src/lib/chat/constants.ts, src/app/api/chat/route.ts</files>
  <action>
Update system prompt in constants.ts:

1. Add to capabilities section:
   "- Search the web for EU market alternatives using the searchExternalProducts tool"

2. Add guideline for when to use:
   "- When user asks for 'alternatives' or to 'search the web' for a catalog product, use searchExternalProducts tool"
   "- Before web search, confirm: 'Searching the web for alternatives to [product]...'"

3. REMOVE from limitations section:
   "- Cannot search external websites (catalog only)"

4. Add note about external results:
   "- External search results are leads to investigate, not verified products in our catalog"

Update API route in route.ts:

1. Import searchExternalProducts from '@/lib/chat/tools'
2. Add to tools object in streamText call:
   tools: {
     searchProducts,
     comparePrices,
     suggestCategories,
     searchExternalProducts,  // Add this
   }

No other changes needed - existing stepCountIs(3) and error handling apply.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
System prompt includes searchExternalProducts: grep SYSTEM_PROMPT in constants.ts
Tool registered: grep searchExternalProducts in route.ts
  </verify>
  <done>
System prompt updated with web search capability and guidelines, searchExternalProducts registered in API route tools object, "cannot search external" limitation removed
  </done>
</task>

<task type="auto">
  <name>Task 3: Test tool execution with manual request</name>
  <files>N/A - verification only</files>
  <action>
Start dev server and test the tool via chat interface:

1. `npm run dev`
2. Open chat widget
3. First, search for a catalog product: "show me titanium knee implants"
4. Then request web search: "find alternatives to [first product name] on EU market"
5. Check browser Network tab for chat API response structure

Expected behavior:
- AI should acknowledge with "Searching the web for alternatives to..."
- Tool should execute (may take longer than catalog tools)
- Response should include summary text
- If grounding works, response should have sources array

Note: UI rendering of external results is handled in Plan 11-02. This test verifies:
- Tool triggers on explicit request
- Tool executes without error
- Response includes expected structure (summary, sources, hasResults)

If grounding fails silently (no sources), check:
- GEMINI_API_KEY validity
- generateText call parameters
- providerMetadata extraction path
  </action>
  <verify>
Dev server runs: `npm run dev` completes without error
Chat responds to "find alternatives" request without 500 error
Browser console shows no runtime errors
  </verify>
  <done>
searchExternalProducts tool executes when user requests alternatives, returns response structure with summary and sources (even if empty), no API errors
  </done>
</task>

</tasks>

<verification>
All checks pass:
- [ ] TypeScript compiles without errors
- [ ] searchExternalProducts exported from tools.ts
- [ ] Tool uses isolated generateText call (not mixed with other tools)
- [ ] System prompt describes web search capability
- [ ] Tool registered in API route
- [ ] Manual test: "find alternatives to X" triggers tool without errors
</verification>

<success_criteria>
1. User can type "find alternatives to [product] on EU market" and tool executes
2. Tool uses isolated Gemini call with googleSearch grounding (not mixed with custom tools)
3. Response includes summary text and sources array with url/title/domain
4. Existing tools (searchProducts, comparePrices, suggestCategories) still work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-external-web-search/11-01-SUMMARY.md`
</output>
