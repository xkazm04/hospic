---
phase: 11-external-web-search
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/chat/external-product-card.tsx
  - src/components/chat/message-list.tsx
autonomous: true

must_haves:
  truths:
    - "External results display with distinct blue accent styling"
    - "Each external card shows product name and clickable source domain link"
    - "AI summary appears above external cards with numbered references"
  artifacts:
    - path: "src/components/chat/external-product-card.tsx"
      provides: "Card component for external web search results"
      min_lines: 20
    - path: "src/components/chat/message-list.tsx"
      provides: "Handles tool-searchExternalProducts rendering"
      contains: "tool-searchExternalProducts"
  key_links:
    - from: "src/components/chat/message-list.tsx"
      to: "src/components/chat/external-product-card.tsx"
      via: "import ExternalProductCard"
      pattern: "ExternalProductCard"
    - from: "src/components/chat/message-list.tsx"
      to: "tool output"
      via: "renderPart switch case"
      pattern: "case 'tool-searchExternalProducts'"
---

<objective>
Create the UI components for rendering external web search results in the chat interface with distinct styling.

Purpose: Display EU market alternatives from web search with clear visual distinction from catalog products.

Output: ExternalProductCard component and message-list integration showing external results with blue accent borders.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-external-web-search/11-CONTEXT.md
@.planning/phases/11-external-web-search/11-RESEARCH.md
@.planning/phases/11-external-web-search/11-01-SUMMARY.md

@src/components/chat/product-card.tsx
@src/components/chat/message-list.tsx
@src/lib/chat/tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExternalProductCard component</name>
  <files>src/components/chat/external-product-card.tsx</files>
  <action>
Create new component for rendering external web search results per CONTEXT.md decisions.

Props interface:
```typescript
interface ExternalProductCardProps {
  name: string;        // Product/page title from grounding
  sourceUrl: string;   // Full URL to source
  sourceDomain: string; // Domain name only (e.g., "medicaldevices.eu")
}
```

Component requirements:
1. Blue accent border (border-2 border-blue-500) to distinguish from catalog cards
2. Subtle blue background tint (bg-blue-50/10 or similar)
3. Product name as h4 with font-medium text-sm
4. Source domain as clickable link:
   - Opens in new tab (target="_blank")
   - rel="noopener noreferrer" for security
   - Blue text color (text-blue-600)
   - Hover underline effect
   - Display domain only, not full URL
5. No expand/collapse - minimal info per CONTEXT.md (user clicks through for details)
6. Rounded corners (rounded-lg) and padding (p-3) matching ProductCard
7. mb-2 for spacing between cards

Follow existing ProductCard.tsx patterns for consistency but keep simpler (no motion expand, no action buttons).

Mark as 'use client' since it may need interactivity in future.
  </action>
  <verify>
File exists: `ls src/components/chat/external-product-card.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ExternalProductCard component created with blue accent border styling, displays name and clickable domain link opening in new tab
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend message-list to render external search results</name>
  <files>src/components/chat/message-list.tsx</files>
  <action>
Extend MessageList component to handle searchExternalProducts tool output.

1. Import ExternalProductCard:
   `import { ExternalProductCard } from './external-product-card';`

2. Add type for external search output (near other output types):
```typescript
interface ExternalSearchOutput {
  summary: string;
  sources: Array<{
    url: string;
    title: string;
    domain: string;
  }>;
  searchQueries: string[];
  hasResults: boolean;
}
```

3. Add case in renderPart switch statement:
```typescript
case 'tool-searchExternalProducts': {
  if (!isToolPart(part)) return null;
  const toolPart = part as ToolPartBase & { output?: ExternalSearchOutput };

  // Loading state
  if (toolPart.state !== 'output-available' || !toolPart.output) {
    return (
      <LoadingSpinner
        key={toolPart.toolCallId}
        text="Searching the web for alternatives..."
      />
    );
  }

  // No results
  if (!toolPart.output.hasResults) {
    return (
      <p key={toolPart.toolCallId} className="text-sm text-muted-foreground">
        No external alternatives found. Try a different product or broader category.
      </p>
    );
  }

  // Filter out sources with invalid URLs (broken link handling per CONTEXT.md line 26)
  // Hide unavailable sources rather than showing with warning
  const validSources = toolPart.output.sources.filter(source => {
    if (!source.url || source.url.trim() === '') return false;
    try {
      new URL(source.url);
      return true;
    } catch {
      return false;
    }
  });

  // If all sources were invalid, show no-results state
  if (validSources.length === 0) {
    return (
      <p key={toolPart.toolCallId} className="text-sm text-muted-foreground">
        No external alternatives found. Try a different product or broader category.
      </p>
    );
  }

  // Results with cards (filtering out broken links)
  return (
    <div key={toolPart.toolCallId} className="space-y-2">
      {/* AI summary is rendered as separate text part by AI, cards only here */}
      {validSources.map((source, idx) => (
        <ExternalProductCard
          key={`${toolPart.toolCallId}-${idx}`}
          name={source.title}
          sourceUrl={source.url}
          sourceDomain={source.domain}
        />
      ))}
    </div>
  );
}
```

NOTE: The AI summary with numbered references [1], [2] is generated by the model as a text part. The tool output contains the raw summary but the model typically synthesizes it into a user-facing message. Let the model handle summary presentation - we just render the cards.

Place the new case after 'tool-suggestCategories' and before 'default'.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Import exists: grep "ExternalProductCard" in message-list.tsx
Case exists: grep "tool-searchExternalProducts" in message-list.tsx
URL validation: grep "new URL(source.url)" in message-list.tsx
  </verify>
  <done>
MessageList handles tool-searchExternalProducts with loading state, no-results state, broken link filtering, and external cards rendering
  </done>
</task>

<task type="auto">
  <name>Task 3: Visual verification in chat interface</name>
  <files>N/A - verification only</files>
  <action>
Test the complete external search flow visually:

1. `npm run dev`
2. Open browser to localhost:3000
3. Open chat widget
4. Search for a catalog product: "show me titanium hip stems"
5. Request alternatives: "find alternatives to [first product] on EU market"

Expected behavior:
1. Loading spinner shows "Searching the web for alternatives..."
2. After search completes, external cards appear with:
   - Blue border (distinct from catalog product cards)
   - Product/page title
   - Clickable domain link in blue
3. AI provides summary text above or around cards
4. Clicking link opens source in new tab
5. Mixed display: catalog cards (no blue border) vs external cards (blue border) are visually distinct

Edge cases to check:
- No results found: should show "No external alternatives found" message
- Broken/missing sources: cards should not render (filtered out silently per CONTEXT.md)

If grounding returns no sources (metadata missing), the tool still returns hasResults: false, showing the appropriate message.
  </action>
  <verify>
Dev server runs without error
External cards render with blue border styling
Links open in new tab
Loading state displays correctly
  </verify>
  <done>
External web search results display with distinct blue accent styling, clickable source links open in new tabs, broken links filtered out silently, loading and empty states work correctly
  </done>
</task>

</tasks>

<verification>
All checks pass:
- [ ] ExternalProductCard component exists and compiles
- [ ] Blue accent border (border-blue-500) applied
- [ ] Links open in new tab with noopener noreferrer
- [ ] MessageList handles tool-searchExternalProducts case
- [ ] Loading spinner shows "Searching the web for alternatives..."
- [ ] No-results state shows helpful message
- [ ] Broken/invalid URLs filtered out (not shown with warning)
- [ ] Visual test: external cards clearly distinct from catalog cards
</verification>

<success_criteria>
1. External results display with blue accent border (visually distinct from catalog)
2. Each card shows product name and clickable source domain
3. Clicking domain opens source URL in new tab
4. Loading state shows "Searching the web for alternatives..."
5. No results case handled gracefully with helpful message
6. Broken/invalid source links hidden silently (per CONTEXT.md line 26)
</success_criteria>

<output>
After completion, create `.planning/phases/11-external-web-search/11-02-SUMMARY.md`
</output>
